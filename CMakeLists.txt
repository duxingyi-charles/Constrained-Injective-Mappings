cmake_minimum_required(VERSION 3.15.0)
project(TLC VERSION 0.1.0 LANGUAGES CXX C)

set(CMAKE_CXX_STANDARD 14)
set(BUILD_SHARED_LIBS OFF CACHE BOOL "Do not use shared lib.")


include(FetchContent)
include(cmake/Eigen3.cmake)
include(cmake/cli11.cmake)
include(cmake/nlohmann-json.cmake)
include(cmake/nlopt.cmake)



aux_source_directory(${PROJECT_SOURCE_DIR}/src SRC_LIST)

add_library(arcOverlap STATIC ${SRC_LIST})
target_include_directories(arcOverlap PUBLIC ${PROJECT_SOURCE_DIR}/src)
target_link_libraries(arcOverlap PUBLIC Eigen3::Eigen)

# OpenMP
find_package(OpenMP)
if(OpenMP_CXX_FOUND)
    target_link_libraries(arcOverlap PUBLIC OpenMP::OpenMP_CXX)
endif()

add_executable(TLC_QN apps/TLC_QN.cpp)
target_link_libraries(TLC_QN PUBLIC arcOverlap nlopt::nlopt)
set_target_properties(TLC_QN PROPERTIES LINKER_LANGUAGE CXX)



add_executable(arc_arc_intersection_test apps/arc_arc_intersection_test.cpp)
target_link_libraries(arc_arc_intersection_test PUBLIC arcOverlap)

add_executable(subdivide_polyArc_test apps/subdivide_polyArc_test.cpp)
target_link_libraries(subdivide_polyArc_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(cell_decompose_test apps/cell_decompose_test.cpp)
target_link_libraries(cell_decompose_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(arrangement_test apps/arrangement_test.cpp)
target_link_libraries(arrangement_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(arc_occupancy_test apps/arc_occupancy_test.cpp)
target_link_libraries(arc_occupancy_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(arc_occupancy_gradient_test apps/arc_occupancy_gradient_test.cpp)
target_link_libraries(arc_occupancy_gradient_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(SEA_test apps/SEA_test.cpp)
target_link_libraries(SEA_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(SEA_Iso_test apps/SEA_Iso_test.cpp)
target_link_libraries(SEA_Iso_test PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(SEA_2D_QN apps/SEA_2D_QN.cpp)
target_link_libraries(SEA_2D_QN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json nlopt::nlopt)

# experimental PN solver for SEA, not recommended for practical use
add_executable(SEA_2D_PN apps/SEA_2D_PN.cpp)
target_link_libraries(SEA_2D_PN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(SEA_Iso_2D_QN apps/SEA_Iso_2D_QN.cpp)
target_link_libraries(SEA_Iso_2D_QN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json nlopt::nlopt)

add_executable(sTLC_Iso_2D_QN "apps/sTLC_Iso_2D_QN.cpp")
target_link_libraries(sTLC_Iso_2D_QN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json nlopt::nlopt)

add_executable(sTGC_2D_QN "apps/sTGC_2D_QN.cpp")
target_link_libraries(sTGC_2D_QN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json nlopt::nlopt)

add_executable(sTGC_2D_PN "apps/sTGC_2D_PN.cpp")
target_link_libraries(sTGC_2D_PN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(sTGC_3D_QN "apps/sTGC_3D_QN.cpp")
target_link_libraries(sTGC_3D_QN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json nlopt::nlopt)

add_executable(sTGC_3D_PN "apps/sTGC_3D_PN.cpp")
target_link_libraries(sTGC_3D_PN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json)

add_executable(SEA_Generalized_2D_QN "apps/SEA_Generalized_2D_QN.cpp")
target_link_libraries(SEA_Generalized_2D_QN PUBLIC arcOverlap CLI11::CLI11 nlohmann::json nlopt::nlopt)

# suitesparse

# suitesparse installed by homebrew (Apple Silicon)
set(SUITESPARSE_INCLUDE_DIR /opt/homebrew/include/suitesparse CACHE PATH "suitesparse include directory")
target_include_directories(SEA_2D_PN PUBLIC "${SUITESPARSE_INCLUDE_DIR}")
target_include_directories(sTGC_2D_PN PUBLIC "${SUITESPARSE_INCLUDE_DIR}")
target_include_directories(sTGC_3D_PN PUBLIC "${SUITESPARSE_INCLUDE_DIR}")

if (WIN32)
    # ------------------------------------------------------------------
    # Detect SuiteSparse libraries:
    # If not found automatically, set SuiteSparse_DIR in CMake to the
    # directory where SuiteSparse-config.cmake was installed.
    # ------------------------------------------------------------------
    find_package(SuiteSparse CONFIG REQUIRED)
    target_link_libraries(SEA_2D_PN PRIVATE SuiteSparse::CHOLMOD)
    target_link_libraries(sTGC_2D_PN PRIVATE SuiteSparse::CHOLMOD)
    target_link_libraries(sTGC_3D_PN PRIVATE SuiteSparse::CHOLMOD)
else()
    # cholmod from suitesparse installed by homebrew (Apple Silicon)
    set(SUITESPARSE_LIB_DIR /opt/homebrew/lib CACHE PATH "suitesparse library directory")
    target_link_libraries(SEA_2D_PN PUBLIC -L"${SUITESPARSE_LIB_DIR}" cholmod)
    target_link_libraries(sTGC_2D_PN PUBLIC -L"${SUITESPARSE_LIB_DIR}" cholmod)
    target_link_libraries(sTGC_3D_PN PUBLIC -L"${SUITESPARSE_LIB_DIR}" cholmod)
endif()


# Math library
find_library(MATH_LIBRARY m)
if(MATH_LIBRARY)
    target_link_libraries(TLC_QN PUBLIC ${MATH_LIBRARY})
    target_link_libraries(arc_arc_intersection_test PUBLIC ${MATH_LIBRARY})
    target_link_libraries(subdivide_polyArc_test PUBLIC ${MATH_LIBRARY})
endif()